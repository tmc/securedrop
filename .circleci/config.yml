version: 2
jobs:
  build:
    docker:
      - image: gcr.io/cloud-builders/docker
    working_directory: /build
    environment:
      DOCKER_API_VERSION=1.23
    steps:
      - run: apt-get install -y make
      - checkout
      - setup_remote_docker
      - run: cd securedrop && make images TAG=${CIRCLE_SHA1}
      - run: |
          export TESTFILES=$(cd securedrop; circleci tests glob 'tests/test*py' 'tests/**/test*py' |circleci tests split --split-by=timings)
          cd securedrop && make test TAG=${CIRCLE_SHA1}
  testinfra:
    docker:
      - image: gcr.io/cloud-builders/docker
    working_directory: /build
    environment:
      DOCKER_API_VERSION=1.23
    steps:
      - run: apt-get install -y make
      - checkout
      - setup_remote_docker
      - run: cd testinfra && make images TAG=${CIRCLE_SHA1}
